<template>
  <div>

    <div class="content-body">
      <!-- 顶部，包括标题，操作按钮-->
      <div class="bd-top">
        <div class="md clearfix">
          <!-- 1、左边标题 -->
          <div class="md-left">
            <h5>预测式外呼作业</h5>
          </div>
          <!-- 2、右边操作按钮 -->
          <div class="md-right">
            <el-button size="mini" type="primary" @click.native.prevent="addRule" v-if="operationBtns[1].isShow">创建外呼任务</el-button>
            <el-button size="mini" type="primary" @click.native.prevent="addSearchRule" v-if="operationBtns[2].isShow">按筛选创建外呼任务</el-button>
            <el-button size="mini" type="primary" @click.native.prevent="stopCalling" v-if="operationBtns[3].isShow">中断</el-button>
          </div>
        </div>
      </div>
      <div class="bd-main">
        <el-form ref="conditionForm" :model="conditionForm" :label-width="this.$util.LABEL_WIDTH" label-position="right" class="condition-form"
          size="mini">
          <div class="el-col fixed-width">
            <el-form-item label="案件号" prop="caseCode">
              <el-input v-model="conditionForm.caseCode" placeholder="请输入案件号" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="姓名" prop="borrowerName">
              <el-input v-model="conditionForm.borrowerName" placeholder="请输入姓名" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="身份证号" prop="borrowerIdnumber">
              <el-input v-model="conditionForm.borrowerIdnumber" placeholder="请输入身份证号" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="手机号" prop="borrowerPhone">
              <el-input v-model="conditionForm.borrowerPhone" placeholder="请输入手机号" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="贷款机构" prop="loanInstitution">
              <el-select placeholder="请选择贷款机构" v-model="conditionForm.loanInstitution" clearable>
                <el-option v-for="option in dropdownData.loanInstitution" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="产品名称" prop="productName">
              <el-select placeholder="请选择产品名称" v-model="conditionForm.productName" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.productName" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="批次号" prop="batchCode">
              <el-input v-model="conditionForm.batchCode" placeholder="请输入批次号" clearable></el-input>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="案件状态" prop="caseStatus">
              <el-select placeholder="请选择案件状态" v-model="conditionForm.caseStatus" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.caseStatus" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="案件地区" prop="caseArea">
              <el-select placeholder="请选择案件地区" v-model="conditionForm.caseArea" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.caseArea" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="户籍地" prop="registeredAddress">
              <el-select placeholder="请选择户籍地" v-model="conditionForm.registeredAddress" clearable>
                <el-option v-for="option in dropdownData.registeredAddress" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="性别" prop="borrowerGender">
              <el-select placeholder="请选择性别" v-model="conditionForm.borrowerGender" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.gender" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="年龄">
              <el-col :span="11">
                <el-form-item label="" prop="ageMin" ref="ageMin">
                  <el-input v-model="conditionForm.ageMin" placeholder="最小值" clearable></el-input>
                </el-form-item>
              </el-col>
              <el-col class="line" :span="2">-</el-col>
              <el-col :span="11">
                <el-form-item label="" prop="ageMax" ref="ageMax">
                  <el-input v-model="conditionForm.ageMax" placeholder="最大值" clearable></el-input>
                </el-form-item>
              </el-col>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="催收部门" prop="departmentId">
              <el-cascader :options="departments" change-on-select v-model="departmentIds" :props="departmentProps" @change="getDepartmentId"
                clearable>
              </el-cascader>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="催收员" prop="staffId">
              <el-select placeholder="请选择催收员" v-model="conditionForm.staffId" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in staffs" :label="option.name" :value="option.id" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="跟进时间" prop="FollowDate">
              <el-date-picker type="daterange" v-model="conditionForm.FollowDate" format="yyyy/MM/dd" value-format="yyyy-MM-dd" range-separator="-"
                start-placeholder="开始日期" end-placeholder="结束日期" @change="followDate" clearable>
              </el-date-picker>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="催收状态" prop="collectionStatus">
              <el-select placeholder="请选择催收状态" v-model="conditionForm.collectionStatus" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.collectionStatus" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="账龄" prop="receivableAge">
              <el-select placeholder="请选择账龄" v-model="conditionForm.receivableAge" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.receivableAge" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="手别" prop="bacthTimes">
              <el-select placeholder="请选择手别" v-model="conditionForm.bacthTimes" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.bacthTimes" :label="option.name" :value="option.code" :key="option.code"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="逾期天数">
              <el-col :span="11">
                <el-form-item label="" prop="overdueDayMin" ref="overdueDayMin">
                  <el-input v-model="conditionForm.overdueDayMin" placeholder="最小值" clearable></el-input>
                </el-form-item>
              </el-col>
              <el-col class="line" :span="2">-</el-col>
              <el-col :span="11">
                <el-form-item label="" prop="overdueDayMax" ref="overdueDayMax">
                  <el-input v-model="conditionForm.overdueDayMax" placeholder="最大值" clearable></el-input>
                </el-form-item>
              </el-col>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="电话状态" prop="telStatus">
              <el-select placeholder="请选择电话状态" v-model="conditionForm.telStatus" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.telStatus" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="委托时间" prop="CommitDate">
              <el-date-picker type="daterange" value-format="yyyy-MM-dd" format="yyyy/MM/dd" v-model="conditionForm.CommitDate" @change="commitDate"
                range-separator="-" start-placeholder="开始日期" end-placeholder="结束日期" clearable>
              </el-date-picker>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="退案时间" prop="LimitDate">
              <el-date-picker type="daterange" value-format="yyyy-MM-dd" format="yyyy/MM/dd" v-model="conditionForm.LimitDate" @change="limitDate"
                range-separator="-" start-placeholder="开始日期" end-placeholder="结束日期" clearable>
              </el-date-picker>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="委案金额">
              <el-col :span="11">
                <el-form-item label="" prop="commitMoneyMin" ref="commitMoneyMin">
                  <el-input v-model="conditionForm.commitMoneyMin" placeholder="最小值" clearable></el-input>
                </el-form-item>
              </el-col>
              <el-col class="line" :span="2">-</el-col>
              <el-col :span="11">
                <el-form-item label="" prop="commitMoneyMax" ref="commitMoneyMax">
                  <el-input v-model="conditionForm.commitMoneyMax" placeholder="最大值" clearable></el-input>
                </el-form-item>
              </el-col>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="已还款总额">
              <el-col :span="11">
                <el-form-item label="" prop="totalRepayMoneyMin" ref="totalRepayMoneyMin">
                  <el-input v-model="conditionForm.totalRepayMoneyMin" placeholder="最小值" clearable></el-input>
                </el-form-item>
              </el-col>
              <el-col class="line" :span="2">-</el-col>
              <el-col :span="11">
                <el-form-item label="" prop="totalRepayMoneyMax" ref="totalRepayMoneyMax">
                  <el-input v-model="conditionForm.totalRepayMoneyMax" placeholder="最大值" clearable></el-input>
                </el-form-item>
              </el-col>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="最新欠款金额">
              <el-col :span="11">
                <el-form-item label="" prop="latestDebtMoneyMin" ref="latestDebtMoneyMin">
                  <el-input v-model="conditionForm.latestDebtMoneyMin" placeholder="最小值" clearable></el-input>
                </el-form-item>
              </el-col>
              <el-col class="line" :span="2">-</el-col>
              <el-col :span="11">
                <el-form-item label="" prop="latestDebtMoneyMax" ref="latestDebtMoneyMax">
                  <el-input v-model="conditionForm.latestDebtMoneyMax" placeholder="最大值" clearable></el-input>
                </el-form-item>
              </el-col>
            </el-form-item>
          </div>
          <div class="el-col fixed-width">
            <el-form-item label="案件标签" prop="caseLabel">
              <el-select placeholder="请选择案件标签" v-model="conditionForm.caseLabel" clearable>
                <el-option label="All" value=""></el-option>
                <el-option v-for="option in dropdownData.caseLabel" :label="option.name" :value="option.code" :key="option.id"></el-option>
              </el-select>
            </el-form-item>
          </div>
          <div class="el-col fixed-width twoSelects" style="width:40%">
            <el-form-item label="是否创建外呼任务" prop="proCallDate" label-width="120px">
              <el-row>
                <el-col :span="12">
                  <el-date-picker v-model="conditionForm.proCallDate" placeholder="请选择任务执行日期" type="date" value-format="yyyy-MM-dd"  clearable>
                  </el-date-picker>
                </el-col>
                <el-col :span="8">
                  <el-select placeholder="是否创建" v-model="conditionForm.proCallStatus" clearable>
                    <el-option v-for="option in createdStatus" :label="option.name" :value="option.code" :key="option.id"></el-option>
                  </el-select>
                </el-col>
              </el-row>
            </el-form-item>

          </div>
          <div class="el-col fixed-width form-btns">
            <el-button size="mini" @click="search" type="primary">搜索</el-button>
            <el-button size="mini" @click="reset">重置</el-button>
          </div>
        </el-form>
        <el-table ref="multipleTable" height="650" :data="tb.data" tooltip-effect="dark" v-loading="loading" element-loading-text="拼命加载中"
          element-loading-spinner="el-icon-loading" @selection-change="handleSelectionChange">
          <el-table-column type="selection" width="50"></el-table-column>
          <el-table-column v-for="field in tb.fields" :align="field.align||'center'" :prop="field.key" :label="field.label" :width="field.width"
            :key="field.id">
            <template slot-scope="scope">
              <!-- 普通样式 -->
              <template v-if="field.type == '0'">
                {{scope.row[scope.column.property]}}
              </template>
              <!-- 按钮类型 -->
              <template v-if="field.type == '1'">
                <el-button size="mini" @click.native.prevent="" type="text">
                  {{scope.row[scope.column.property]}}
                </el-button>
              </template>
              <!-- a标签 -->
              <template v-if="field.type == '2'">
                <a href="javascript:void(0)" @click="goDetail(scope,field.caseListType)" style="text-decoration:underline;" class="el-button--text el-button--small">{{scope.row[scope.column.property]}}</a>
              </template>
            </template>
          </el-table-column>
        </el-table>
        <el-pagination small :total="total" :current-page.sync="conditionForm.currentPage" :page-size="conditionForm.pageSize" @current-change="handleCurrentChange"
          layout="sizes,total, prev, pager, next,jumper" @size-change="changeSize" :page-sizes="[15, 50, 100]">
        </el-pagination>
      </div>

    </div>
    <!-- 创建外呼 -->
    <el-dialog :title="title" :visible.sync="visible" :close-on-click-modal="false" @close="close">
      <el-form :model="dialogForm" label-width="150px" size="small" ref="dialogForm"  class="dialog-main" >
        <el-form-item label="开始时间" prop="startDate" :rules="[{ required: true, message: '必填项',trigger:'blur'},]">
          <el-date-picker v-model="dialogForm.startDate" placeholder="请选择任务执行日期" type="date" value-format="yyyy-MM-dd" clearable :picker-options="pickerOptions0" >
          </el-date-picker>
        </el-form-item>
        <el-form-item label="选择外呼规则" prop="callRuleId" :rules="[ { required: true, message: '必填项',trigger:'blur'}]">
          <el-select placeholder="选择外呼规则" v-model="dialogForm.callRuleId" clearable @change="chooseRule">
            <el-option v-for="option in this.ruleList" :label="option.name" :value="option.code" :key="option.id"></el-option>
          </el-select>
        </el-form-item>
        <!-- <el-form-item label="规则名称" prop="ruleName"  >
          <el-input v-model="dialogForm.ruleName"  clearable ></el-input>
        </el-form-item> -->
        <el-form-item label="失败重复次数" prop="failRetryTimes">
          <!-- <el-input v-model="conditionForm.failRetryTimes" type="number"></el-input> -->
          <el-select v-model="dialogForm.failRetryTimes" disabled>
            <el-option v-for="item in [0,1,2,3,4,5]" :key="item" :label="item" :value="item"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="接通重呼条件(秒)" prop="retryLessBillsec">
          <el-input v-model="dialogForm.retryLessBillsec" disabled></el-input>
        </el-form-item>
        <el-form-item label="接通重呼次数" prop="retryTimes">
          <el-input v-model="dialogForm.retryTimes" disabled></el-input>
        </el-form-item>
        <el-form-item label="当日重呼间隔(分钟)" prop="retryIntervalTime">
          <el-input v-model="dialogForm.retryIntervalTime" disabled></el-input>
        </el-form-item>
        <el-form-item label="工作时间" prop="workTime">
          <el-row v-for="item in dialogForm.workTimes" :key="item.id" style="margin-bottom:10px" >
            <el-col :span="10">
              <el-time-select disabled placeholder="起始时间" v-model="item[0]" :picker-options="{
                        start: item.start,
                        step: '00:15',
                        end: '24:00'
                    }">
              </el-time-select>
            </el-col>
            <el-col :span="2" style="text-align:center">-</el-col>
            <el-col :span="10">
              <el-time-select disabled placeholder="结束时间" v-model="item[1]" @change="transfromTime" :picker-options="{
                        start: item.start,
                        step: '00:15',
                        end: '24:00',
                        minTime: item.startTime
                    }">
              </el-time-select>
            </el-col>
            <!-- <el-col :span="1" :offset="1">
              <i class="el-icon-delete" @click="removeTime(index)" v-if="index!=0"></i>
            </el-col> -->
          </el-row>
        </el-form-item>
        <!-- <el-button type="primary" size="mini" icon="el-icon-circle-plus-outline" style="margin: -20px 0 0 150px" @click="addTime">添加时间</el-button> -->
      </el-form>
      <div class="dialog_submit">
        <el-button @click.native.prevent="dialogCloseHandle" size="small">取 消</el-button>
        <el-button type="primary" @click.native.prevent="dialogSubmitHandle" size="small">确 定</el-button>
      </div>
    </el-dialog>
  </div>

</template>
<script>
  const fields = [
    {
      key: "caseCode",
      label: "案件编号",
      width: "100",
      type: 0
    },
    {
      key: "batchCode",
      label: "批次号",
      width: "100",
       type: 0
    },
    {
      key: "borrowerName",
      label: "姓名",
      width: "80px",
       type: 0
    },
    {
      key: "borrowerIdnumber",
      label: "身份证",
      width: "180",
       type: 0
    },
    {
      key: "borrowerPhone",
      label: "手机号",
      width: "120",
       type: 0
    },
    {
      key: "borrowerAge",
      label: "年龄",
      width: "50",
       type: 0
    },
    {
      key: "borrowerGenderName",
      label: "性别",
      width: "50",
       type: 0
    },
    {
      key: "latestDebtMoney",
      label: "最新欠款金额",
      width: "100",
      align: 'right',
       type: 0
    },
    {
      key: "commitMoney",
      label: "委案金额",
      width: "auto",
      align: 'right',
       type: 0
    },
    {
      key: "totalRepayMoney",
      label: "已还款总额",
      width: "auto",
      align: 'right',
       type: 0
    },
    {
      key: "totalReduceMoney",
      label: "减免总金额",
      width: "auto",
      align: 'right',
       type: 0
    },
    {
      key: "loanInstitution",
      label: "贷款机构",
      width: "auto",
      align: 'right',
       type: 0
    },
    {
      key: "productName",
      label: "贷款产品",
      width: "auto",
      align: 'right',
       type: 0
    },
    {
      key: "overdueDay",
      label: "逾期天数",
      width: "auto",
       type: 0
    },
    {
      key: "receivableAge",
      label: "账龄",
      width: "50",
       type: 0
    },
    {
      key: "bacthTimes",
      label: "手别",
      width: "50",
       type: 0
    },
    // {
    //     key: "totalDebtMoney",
    //     label: "欠款金额",
    //     width: "auto",
    //     align: 'right',
    // },

    {
      key: "commitDate",
      label: "委案时间",
      width: "100",
       type: 0
    },
    {
      key: "limitDate",
      label: "退案时间",
      width: "100",
       type: 0
    },
    {
      key: "caseArea",
      label: "案件地区",
      width: "",
       type: 0
    },
    {
      key: "registeredAddress",
      label: "户籍地",
      width: "",
       type: 0
    },
    // {
    //   key: "staffName",
    //   label: "催收员（ID）",
    //   width: "100",
    //    type: 0
    // },
    {
      key: "departmentName",
      label: "部门",
      width: "auto",
       type: 0
    },
    {
      key: "followDate",
      label: "跟进时间",
      width: "100",
       type: 0
    },
    // {
    //     key: "allotStatusName",
    //     label: "分配状态",
    //     width: "auto",
    // },
    {
      key: "caseStatusName",
      label: "案件状态",
      width: "auto",
       type: 0
    },
    {
      key: "collectionStatusName",
      label: "催收状态",
      width: "100",
       type: 0
    },
    {
      key: "caseLabel",
      label: "案件标签",
      width: "100",
       type: 0
    },
    {
      key: "ruleName",
      label: "外呼规则",
      width: "100",
       type: 0
    },
    {
      key: "telStatusName",
      label: "电话状态",
      width: "auto",
       type: 0
    }
  ]
  export default {
    components: {},
    computed: {},
    created() {
      // 获取该页的identifier
      let param = {
        identifier: this.$route.path.slice(1)
      }
      this.$util.getPageResourceByMenu(param, this, function () {});
      this.conditionForm.proCallDate =  moment().format('YYYY-MM-DD');
      //console.log(this.$router)
      // this.$util.getPageResourceByMenu(param,this)
      this.searchForm = Object.assign({}, this.conditionForm);
      this.getList(this.conditionForm);
      this.getdropdownData()
      this.getRuleList();
      this.getApartment();
    },
    data() {
      var validateMoneyMin = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,9}([.][0-9]{0,2})?$/;
            if (!pattern.test(value)) {
              callback(new Error("最多10位整数和2位小数"));
            } else if (this.conditionForm.consignerMoneyMax && (this.conditionForm.consignerMoneyMax - 0 < this.conditionForm
                .consignerMoneyMin - 0)) {
              callback(new Error('最小值不能大于最大值'))
            } else {
              this.$refs['consignerMoneyMax'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        },
        validateMoneyMax = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,9}([.][0-9]{0,2})?$/;
            if (!pattern.test(value)) {
              callback(new Error("最多10位整数和2位小数"));
            } else if (this.conditionForm.consignerMoneyMin && (this.conditionForm.consignerMoneyMax - 0 < this.conditionForm
                .consignerMoneyMin - 0)) {
              callback(new Error('最小值不能大于最大值'))
            } else {
              this.$refs['consignerMoneyMin'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        },
        validateCountMin = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,5}$/;
            if (!pattern.test(value)) {
              callback(new Error("最多6位整数"));
            } else if (this.conditionForm.consignerCountMax && (this.conditionForm.consignerCountMax - 0 < this.conditionForm
                .consignerCountMin - 0)) {
              callback(new Error('最小值不能大于最大值'))
            } else {
              this.$refs['consignerCountMax'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        },
        validateCountMax = (rule, value, callback) => {
          if (value) {
            let pattern = /^[1-9][0-9]{0,5}$/;
            if (!pattern.test(value)) {
              callback(new Error("最多6位整数"));
            } else if (this.conditionForm.consignerCountMin && (this.conditionForm.consignerCountMax - 0 < this.conditionForm
                .consignerCountMin - 0)) {
              callback(new Error('最小值不能大于最大值'))
            } else {
              this.$refs['consignerCountMin'].clearValidate()
              callback();
            }
          } else {
            callback();
          }
        };
      const validateInter = (rule, value, callback) => {
        if (value) {
          let pattern = /^[0-9]{0,}$/;
          if (!pattern.test(value)) {
            callback(new Error("必须为整数"));
          } else {
            callback();
          }
        } else {
          callback();
        }
      }

      return {
        selected: [],
        operationBtns: [{
          name: '查看',
          identifier: 'sponsor_position_search',
          isShow: true,
        }, {
          name: '批次案件分发',
          identifier: 'sponsor_position_create',
          dialog: {
            dialogFormVisible: false,
            form: {
              orgId: '',
              batchCodes: [],
              companyOrgSigns: []
            },
            rule: {


            },
            url: '/api/sponsor/batchManage/allocationBatch',
            formName: 'createForm',
            title: '批次案件分发',
          },
          isShow: true,

        }, ],
        dateObjs: {
          commitDate: '',
          limitDate: ''
        },
        pickerOptions2: {
          onPick: function (min, max) {

          }
        },
        createdStatus: [{
            name: '未创建',
            colde: 0
          },
          {
            name: '已创建',
            code: 1
          }
        ],
        pickerOptions0: {
          disabledDate(time) {
            return time.getTime() < Date.now() - 8.64e7
          }
        },
        visible: false,
        departmentProps: {
          label: "name",
          value: "id"
        },
        conditionForm: {
          borrowerName: "",
          borrowerIdnumber: "",
          borrowerPhone: "",
          loanInstitution: "",
          productName: "",
          batchCode: "",
          caseCode: "",
          registeredAddress: "",
          caseArea: "",
          borrowerGender: "",
          ageMin: "",
          ageMax: "",
          departmentId: "",
          staffId: "",
          telStatus: "",
          receivableAge: "",
          bacthTimes: "",
          overdueDayMin: "",
          overdueDayMax: "",
          commitMoneyMin: "",
          commitMoneyMax: "",
          debtMoneyMin: "",
          debtMoneyMax: "",
          commitDateMin: "",
          limitDateMin: "",
          commitDateMax: "",
          limitDateMax: "",
          caseStatus: "",
          collectionStatus: "",
          followDateMin: "",
          followDateMax: "",
          currentPage: 1,
          pageSize: 15,
          CommitDate: [],
          LimitDate: [],
          FollowDate: [],
          totalRepayMoneyMax: '',
          totalRepayMoneyMin: '',
          caseLabel: '',
          proCallDate: '',
          collectionManageQueryType: 'manual',
          proCallStatus: '',
          latestDebtMoneyMax: '',
          latestDebtMoneyMin: ''
        },
        dialogForm: {
          failRetryTimes: '',
          retryIntervalTime: '',
          retryLessBillsec: '',
          retryTimes: '',
          ruleName: '',
          workTimes: [],
          callRuleId: '',
          startDate:'',
        },
        departments: [],
        department: [],
        staffs: [],
        departmentIds: [],
        loanInstitution: [],
        tb: {
          data: [],
          fields: fields,
        },
        loading: true,
        currentPage: 1,
        pageSize: 15,
        total: 0,
        batchData: [],
        link: '',
        dropdownData: {},
        AllAssigneeOrg: [],
        startTime: '',
        endTime: '',
        workTimes: [{
          startTime: '',
          endTime: '',
          start: '00:00',
          end: '24:00'
        }],
        ruleList: [],
        item: '',
        operationBtns: [
             {
            name: "查看",
            identifier: "assignee_call_work_search",
            isShow: false
          },
          {
            name: "创建",
            identifier: "assignee_call_work_create",
            isShow: false
          },
          {
            name: "筛选添加外呼任务",
            identifier: "assignee_call_work_create_by_condition",
            isShow: false
          },
          {
            name: "中断",
            identifier: "assignee_call_work_stop",
            isShow: false
          }, 
        ],
        title: '创建外呼任务'
      }
    },
    methods: {
       // 权限
    //    checkPermission(that) {
    //      this.operationBtn[0].isShow = that.operationBtns[0].isShow;
    //      this.operationBtn[1].isShow = that.operationBtns[1].isShow;
    //      this.operationBtn[2].isShow = that.operationBtns[2].isShow;
    //      this.operationBtn[3].isShow = that.operationBtns[3].isShow;
    //   },
      search() {
        this.$refs.conditionForm.validate((valid) => {
          if (valid) {
            this.searchForm = Object.assign({}, this.conditionForm);
            if (this.conditionForm.currentPage == 1) {
              this.getList(this.conditionForm);
            } else {
              this.conditionForm.currentPage = 1;
              this.hasSearch = true;
            }
            //   this.conditionForm.currentPage = 1;
          }
        })
      },
      reset() {
        this.$refs.conditionForm.resetFields();
        this.conditionForm.consignerDateMin = '';
        this.conditionForm.consignerDateMax = '';
        this.conditionForm.limitDateMin = '';
        this.conditionForm.limitDateMax = '';
        this.conditionForm.commitDateMin = '';
        this.conditionForm.commitDateMax = '';
        this.conditionForm.followDateMin = '';
        this.conditionForm.followDateMax = '';
        this.searchForm = Object.assign({}, this.conditionForm)
        if (this.conditionForm.currentPage == 1) {
          this.getList(this.conditionForm);
        } else {
          this.conditionForm.currentPage = 1;
          this.hasSearch = true;
        }
      },
      handleCurrentChange(index) {
        this.searchForm.currentPage = index;
        if (this.hasSearch) {
          this.getList(this.conditionForm);
          this.hasSearch = false;
        } else {
          this.conditionForm = Object.assign({}, this.searchForm);
          this.getList(this.searchForm);
        }
      },
      goDetail(scope, caseListType) {
        // let params = qs.stringify(this.$util.encodePostBody({
        //   detail:scope.row,
        //   caseListType:caseListType,
        // }))
        var type, batchCode = scope.row.batchCode,
          batchName = scope.row.batchName;
        var enBatchCode = this.$util.encrypt(batchCode, 'batch');
        var enBatchName = batchName ? this.$util.encrypt(batchName, 'batch') : '';
        switch (scope.column.label) {
          case '委案数量':
            type = 1;
            break;
          case '已结案件':
            type = 2;
            break;
          case '未结案件':
            type = 3;
            break;
          case '本月未跟进':
            type = 4;
            break;
          case '本月跟进':
            type = 5;
            break;
          default:
            1;
        }
        var url = (window.location.origin ? window.location.origin : '') + '/#/assignee_batch_detail?type=' + type +
          '&batchCode=' + enBatchCode + '&batchName=' + enBatchName;
        window.open(url);
      },
      openDialog(btn) {
        if (this.selected.length >= 1) {
          //  code: "0", name: "全部待分配"
          if (this.selected.every(item => {
              return item.batchAllotStatus == 0
            })) {
            // 打开dialog选择催收机构
            btn.dialog.form.batchCodes = []
            btn.dialog.form.companyOrgSigns = []
            this.selected.forEach(item => {
              btn.dialog.form.batchCodes.push(item.batchCode)
              btn.dialog.form.companyOrgSigns.push(item.consignerCompanySign)
            })
            this.getAllAssigneeOrg()

            if (this.$refs[btn.dialog.formName] !== undefined) {
              this.$refs[btn.dialog.formName].resetFields()
            }

            btn.dialog.dialogFormVisible = true
          } else {
            this.$alert("请选择全部待分配的记录进行操作！", "提示", {
              confirmButtonText: "确定"
            });
          }
        } else {
          this.$alert("请选择一条记录进行操作！", "提示", {
            confirmButtonText: "确定"
          });
        }

      },
      getAllAssigneeOrg() {
        // 获取催收机构列表
        this.$axios.post('/api/sponsor/caseManage/getAllAssigneeOrg').then((res) => {
          if (res.data.code == 0) {
            this.AllAssigneeOrg = res.data.data
          } else {
            this.$util.failCallback(res.data, this)
          }
        }).catch((err) => {
          console.log(err)
        })
      },
      getdropdownData(cb) {
        // 获取下拉数据
        this.$axios.post('/api/assignee/proactiveCallManage/queryPredictiveCallConditionInit', {}).then((res) => {
          if (res.data.code == 0) {
            this.dropdownData = res.data.data
          } else {
            this.$util.failCallback(res.data, this)
          }
        }).catch((err) => {
          console.log(err)
        })
      },
      consignerDateChange(val) {
        if (val == null) {
          this.conditionForm.consignerDateMin = ''
          this.conditionForm.consignerDateMax = ''
          return;
        }
        this.conditionForm.consignerDateMin = val[0]
        this.conditionForm.consignerDateMax = val[1]
      },
      limitDateChange(val) {
        if (val == null) {
          this.conditionForm.limitDateMin = ''
          this.conditionForm.limitDateMax = ''
          return;
        }
        this.conditionForm.limitDateMin = val[0]
        this.conditionForm.limitDateMax = val[1]
      },
      //委托时间选择
      commitDate(val) {
        if (val) {
          this.conditionForm.commitDateMin = val[0];
          this.conditionForm.commitDateMax = val[1];
        } else {
          this.conditionForm.commitDateMin = '';
          this.conditionForm.commitDateMax = '';
        }
      },
      //截止时间选择
      limitDate(val) {
        if (val) {
          this.conditionForm.limitDateMin = val[0];
          this.conditionForm.limitDateMax = val[1];
        } else {
          this.conditionForm.limitDateMin = '';
          this.conditionForm.limitDateMax = '';
        }
      },
      //跟进时间
      followDate(val) {
        if (val) {
          this.conditionForm.followDateMin = val[0];
          this.conditionForm.followDateMax = val[1];
        } else {
          this.conditionForm.followDateMin = '';
          this.conditionForm.followDateMax = '';
        }
      },
      // 根据条件搜索批次  
      // search() {
      //   let param = Object.assign({}, this.basicParams, this.conditionForm)
      //   this.getList(param)
      // },
      // 获取数据列表
      getList(data) {
        var queryParams;
        if (data) {
          queryParams = data
        } else {
          queryParams = this.conditionForm
        }
        this.loading = true;
        this.$axios.post('/api/assignee/proactiveCallManage/queryPreCallCollection', queryParams).then((res) => {
          if (res.data.code == 0) {
            this.tb.data = res.data.data.items;
           // console.log(this.tb.data)
            this.total = res.data.data.totalNum;
          } else {
            this.$util.failCallback(res.data, this)
          }
          this.loading = false;
        }).catch((err) => {
          this.loading = false
          console.log(err)
        })
      },
      // 获取部门列表
      getApartment() {
        this.$axios
          .post("/api/assignee/caseManage/getDepartmentsCondition", {})
          .then(res => {
            if (res.data.code == 0) {
              this.departments = res.data.data;
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },

      // 选择部门
      getDepartmentId(currentVal) {
        if (currentVal.length == 0) {
          this.staffs = []
          this.conditionForm.staffId = ''
          this.conditionForm.departmentId = ''
        } else {
          this.conditionForm.departmentId = this.departmentIds[this.departmentIds.length - 1];
          this.$axios
            .post("/api/assignee/caseManage/getStaffs", {
              departmentId: this.conditionForm.departmentId
            })
            .then(res => {
              if (res.data.code == 0) {
                this.staffs = res.data.data;
              } else {
                this.$util.failCallback(res.data, this);
              }
            })
            .catch(err => {
              console.log(err);
            });
        }

      },
      // 改变分页size
      changeSize(index) {
        this.conditionForm.pageSize = index;
        this.searchForm.pageSize = index;
        if (this.conditionForm.currentPage == 1) {
          this.getList(this.conditionForm)
        } else {
          this.conditionForm.currentPage = 1;
        }
      },
      // 重置搜索条件
      // reset(form) {

      //   this.$refs.conditionForm.resetFields()
      //   this.dateObjs = {
      //     commitDate: '',
      //     limitDate: ''

      //   }
      //   this.getList(this.basicParams)
      // },
    //   dialogCloseHandle(btn) {
    //     btn.dialog.dialogFormVisible = false
    //   },
    //  创建外呼任务
      dialogSubmitHandle(btn) {
        var data,url;
      //  this.selected = [1,2]
        if(this.item == 0) {
            if(this.selected.length == 0) {
                this.$alert("未选择案件！", "提示", {
                confirmButtonText: "确定",
                type: 'warning'
              });
              return false;
            }
            url = '/api/assignee/proactiveCallManage/createTask',
            data = {
            caseIds: this.selected,
            callRuleId: this.dialogForm.callRuleId,
            startDate: this.dialogForm.startDate
        }
        } else {
           url = '/api/assignee/proactiveCallManage/createTaskByCondition',
           data = this.conditionForm;
           data.startDate = this.dialogForm.startDate;
           data.callRuleId = this.dialogForm.callRuleId;
        }
        this.$refs.dialogForm.validate((valid) => {
          if (valid) {
            this.$axios.post(url, data).then((res) => {
              if (res.data.code == 0) {
                this.dialogCloseHandle();
                this.getList()
                this.$message({
                  type: 'success',
                  message: '创建成功'
                })
              } else {
                this.$util.failCallback(res.data, this)
              }
            }).catch((err) => {
              console.log(err)
            })
          }
        })

      },

      handleSelectionChange(selection) {
        this.selected = [];
        selection.forEach( item => {
            this.selected.push(item.caseId)
        })
      },
      // 关闭弹窗
      dialogCloseHandle() {
        //this.refs['dialogForm'].resetFields();
        this.dialogForm = {
          failRetryTimes: '',
          retryIntervalTime: '',
          retryLessBillsec: '',
          retryTimes: '',
          ruleName: '',
          workTimes: [],
          callRuleId: '',
          startDate:'',
        };
        this.visible = false;
      },
    //   // 提交
    //   dialogSubmitHandle() {
    //     this.$refs['conditionForm'].validate((valid) => {
    //       if (valid) {
    //         this.conditionForm.workTime = ''
    //         this.workTimes.forEach((item) => {
    //           if (item) {
    //             this.conditionForm.workTime += item.startTime + '-' + item.endTime + ',';
    //           }
    //         })
    //         this.$axios
    //           .post("/api/assignee/proactiveCallManage/createPredictiveCallRule", this.conditionForm)
    //           .then(res => {
    //             if (res.data.code == 0) {
    //               this.$message.success('添加成功');
    //               this.dialogCloseHandle();
    //               this.$emit('refresh')
    //             } else {
    //               this.$util.failCallback(res.data, this);
    //             }
    //           })
    //           .catch(err => {
    //             console.log(err);
    //           });
    //       } else {}
    //     });

    //   },
      // 关闭弹窗
      close() {
        this.dialogCloseHandle();
      },
      //添加时间
      addTime() {
        var item = this.workTimes[this.workTimes.length - 1];
        if (item) {
          if (item.startTime && item.endTime != '24:00') {
            this.workTimes.push({
              startTime: '',
              endTime: '',
              start: item.endTime,
              end: '24:00'
            })
          } else if (item.endTime != '24:00') {
            this.$message.warning('请先将工作时间填写完整');
            return false;
          } else {
            this.$message.warning('无时间段可选')
            return false;
          }
        } else {
          this.workTimes.push({
            startTime: '',
            endTime: '',
            start: '00:00',
            end: '24:00'
          })
        }
      },
      // 删除时间
      removeTime(index) {
        if (this.workTimes.length == 1) return false;
        this.workTimes.splice(index, 1);
        if (this.workTimes.length == 0) {
          this.conditionForm.workTime = ''
        }
      },
      // 时间选择
      transfromTime(index) {
        if (index) {
          this.conditionForm.workTime = index;
        }
      },
      // 添加选择规则
      addRule() {
         if(this.selected.length == 0) {
            this.$alert("未选择案件！", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
         }
        this.item = 0;
        this.title = '创建外呼任务'
        this.visible = true;
      },
      // 添加筛选规则
      addSearchRule() {
        if(this.selected.length) {
            this.$alert("此操作为筛选条件下的所有案件，不可筛选！", "提示", {
            confirmButtonText: "确定",
            type: 'warning'
          });
          return false;
         }
        this.item = 1;
        this.title = "按筛选创建外呼任务"
        this.visible = true;
      },
      // 停止外呼
      stopCalling() {
        this.$axios
          .post("/api/assignee/proactiveCallManage/suspendPreCallTask", {caseIds:this.selected,proCallDate:this.conditionForm.proCallDate})
          .then(res => {
            if (res.data.code == 0) {
             this.getList();
             this.$message.success('案件外呼已中断')
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },
      // 获取外访规则列表
      getRuleList() {
        this.$axios
          .post("/api/assignee/proactiveCallManage/queryPreCallRuleListInit", {})
          .then(res => {
            if (res.data.code == 0) {
              this.ruleList = res.data.data;
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      },
      // 选择规则
      chooseRule(code) {
        if(!code) return ;
        this.dialogForm.workTimes = [];
        this.$axios
          .post("/api/assignee/proactiveCallManage/queryPreCallRule", {id:code})
          .then(res => {
            if (res.data.code == 0) {
            //   var startDate = this.dialogForm.startDate;
            //   this.dialogForm = res.data.data;
            //   this.dialogForm.startDate = startDate;
              var resData = res.data.data;
              this.dialogForm.failRetryTimes = resData.failRetryTimes;
              this.dialogForm.retryIntervalTime = resData.retryIntervalTime;
              this.dialogForm.retryLessBillsec = resData.retryLessBillsec;
              this.dialogForm.retryTimes = resData.retryTimes;
              this.dialogForm.workTime = resData.workTime;
              this.dialogForm.ruleName = resData.ruleName
              var times = res.data.data.workTime;
             // times = times.substring(0,times.length -2);
              var arr = times.split(',');
              this.dialogForm.workTimes = [];
              if(arr.length>1) {
                  arr.forEach( (item)=> {
                   var time =  item.split('-');
                   this.dialogForm.workTimes.push([time[0],time[1]])
                  })
              } else if(arr.length == 1) {
                  var item = times.split('-');
                  this.dialogForm.workTimes.push([item[0],item[1]])
              }
            } else {
              this.$util.failCallback(res.data, this);
            }
          })
          .catch(err => {
            console.log(err);
          });
      }
    }
  }

</script>
<style lang="scss" scoped>
  .twoSelects .el-form-item__label {
    width: 120px !important;
  }

  .el-select {
    width: 100%;
  }

  .el-dialog .el-form {
    width: 85%;
    .el-input--suffix .el-input__inner {
      padding-right: 0
    }
  }

  .dialog-footer {
    width: 85%;
    text-align: right;
    margin: 0 auto;
  }

  .el-date-editor.el-input {
    width: 100%
  }

  .el-icon-delete {
    cursor: pointer;
    &:hover {
      color: #f00
    }
  }

</style>
